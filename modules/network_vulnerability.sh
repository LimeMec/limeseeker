#!/usr/bin/env bash

#==========================
# Confirm network scan
# =========================
network_vulnerability() {

    clear
    echo -e "${RED}${BOLD}WARNING!${NC}"
    echo "You are about to perform a network vulnerability scan."
    echo "You must have authorization to scan this network."
    echo

    read -rp "Type YES to continue (10s timeout): " -t 10 CONFIRM

    if [[ "$CONFIRM" != "YES" ]]; then
        echo -e "${YELLOW}Scan aborted by user.${NC}"
        sleep 1
        return
    fi

    echo -e "${GREEN}Authorization confirmed. Starting scan...${NC}"
    sleep 1

# =========================
# NETWORK VULNERABILITY SCAN
# =========================

    clear
    echo -e "${CYAN}${BOLD}======================================================================="
    echo -e "               SCANNING: NETWORK VULNERABILITIES"
    echo -e "=======================================================================${NC}"
    echo

    IFACE=$(ip route | awk '/default/ {print $5}' | head -n 1)
    IP_RANGE=$(ip -o -f inet addr show "$IFACE" | awk '{print $4}')

    # Säkerhetskontroll – endast privata nät
    if [[ ! "$IP_RANGE" =~ ^(10\.|192\.168\.|172\.(1[6-9]|2[0-9]|3[0-1])) ]]; then
        echo -e "${RED}ERROR: Public IP range detected ($IP_RANGE)${NC}"
        pause_and_return
        return
    fi

    echo -e "${GREEN}${BOLD}▶ Interface:${NC} $IFACE"
    echo -e "${GREEN}${BOLD}▶ Target network:${NC} $IP_RANGE"
    echo

    echo -e "${GREEN}${BOLD}▶ Discovering active hosts...${NC}"
    HOSTS=$(nmap -sn "$IP_RANGE" | awk '/Nmap scan report/{print $NF}')

    if [ -z "$HOSTS" ]; then
        echo -e "${RED}No active hosts found${NC}"
        pause_and_return
        return
    fi

    for HOST in $HOSTS; do
        echo
        echo -e "${BLUE}${BOLD}▶ Analyzing host: $HOST${NC}"

        echo -e "${GREEN}• Open ports & services${NC}"
        nmap -sS -sV --open -T3 "$HOST"

        echo -e "${YELLOW}• Vulnerability checks${NC}"
        nmap --script vuln "$HOST"
    done
    
    echo
    echo
    log "Network vulnerability scan completed"
}
