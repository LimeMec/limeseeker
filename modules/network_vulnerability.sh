#!/usr/bin/env bash

#==========================
# Confirm network scan
# =========================
network_vulnerability() {

    if declare -F ui_clear >/dev/null; then
        ui_clear
    fi	

    ui_echo "${RED}${BOLD}WARNING!${NC}"
    log_to_file "WARNING!"
    ui_echo "You are about to perform a network vulnerability scan."
    log_to_file "You are about to perform a network vulnerability scan"
    ui_echo "You must have authorization to scan this network."
    log_to_file "You must have authorization to scan this network"
    ui_echo

    ui_read -rp "Type YES to continue (10s timeout): " -t 10 CONFIRM

    if [[ "$CONFIRM" != "YES" ]]; then
        ui_echo "${YELLOW}Scan aborted by user.${NC}"
        log_to_file "Scan aborted by user."
        sleep 1
        return
    fi

    ui_echo "${GREEN}Authorization confirmed. Starting scan...${NC}"
    log_to_file "Authorization confirmed. Starting scan..."
    sleep 1

    # =========================
    # NETWORK VULNERABILITY SCAN
    # =========================

    ui_clear
    sleep 0.2
    ui_echo
    ui_echo
    ui_echo "${CYAN}${BOLD} Network vulnerability scan...${NC}"
    log_to_file "▶ Network vulnerability scan..."
    ui_echo
    ui_echo
    sleep 0.5

    IFACE=$(ip route | awk '/default/ {print $5}' | head -n 1)
    IP_RANGE=$(ip -o -f inet addr show "$IFACE" | awk '{print $4}')

    # Säkerhetskontroll – endast privata nät
    if [[ ! "$IP_RANGE" =~ ^(10\.|192\.168\.|172\.(1[6-9]|2[0-9]|3[0-1])) ]]; then
        ui_echo "${RED}ERROR: Public IP range detected ($IP_RANGE)${NC}"
        log_to_file "ERROR: Public IP range detected ($IP_RANGE)"
        pause_and_return
        return
    fi

    ui_echo "${GREEN}${BOLD}▶ Interface:${NC} $IFACE"
    log_to_file "▶ Interface: $IFACE"
    ui_echo "${GREEN}${BOLD}▶ Target network:${NC} $IP_RANGE"
    log_to_file "▶ Target network: $IP_RANGE"
    ui_echo

    ui_echo "${GREEN}${BOLD}▶ Discovering active hosts...${NC}"
    log_to_file "▶ Discovering active hosts..."
    HOSTS=$(nmap -sn "$IP_RANGE" | awk '/Nmap scan report/{print $NF}')

    if [ -z "$HOSTS" ]; then
        ui_echo "${RED}No active hosts found${NC}"
        log_to_file "No active hosts found"
        pause_and_return
        return
    fi

    for HOST in $HOSTS; do
        ui_echo
        ui_echo "${BLUE}${BOLD}▶ Analyzing host: $HOST${NC}"
        log_to_file "▶ Analyzing host: $HOST"

        ui_echo "${GREEN}• Open ports & services${NC}"
        log_to_file "Open ports & services"
        nmap -sS -sV --open -T3 "$HOST"

        ui_echo "${YELLOW}• Vulnerability checks${NC}"
        log_to_file "Vulnerability checks"
        nmap --script vulners "$HOST"
    done
    
    ui_echo
    ui_echo
    ui_echo "${GREEN}${BOLD}✔ Network vulnerability scan complete${NC}"
    log_to_file "Network vulnerability scan complete"
}

