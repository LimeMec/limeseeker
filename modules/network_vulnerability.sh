#!/usr/bin/env bash

# ----------------
# Module metadata
# ----------------
network_vulnerability_NAME="Network vulnerability"
network_vulnerability_DESC="
Runs vulnerability-oriented checks against discovered services and hosts.

Highlights:
• NSE/vulners-style checks (if enabled/available)
• Flags findings that require manual validation

Use this to identify potential weaknesses after discovery and port scanning.
"
network_vulnerability_SAFETY="Explicit authorization required. Scans only private IP ranges unless manually configured."


# ----------------------
# Authorization prompt
# ----------------------
network_authorize_prompt() {
    ui_echo "${RED}${BOLD}WARNING!${NC}"
    log_to_file "WARNING!"
    ui_echo "You are about to perform a network vulnerability scan."
    log_to_file "You are about to perform a network vulnerability scan"
    ui_echo "You must have authorization to scan this network."
    log_to_file "You must have authorization to scan this network"
    ui_echo

    ui_read -rp "Type YES to continue (10s timeout): " -t 10 CONFIRM
    [[ "${CONFIRM^^}" == "YES" ]]
}

network_vulnerability() {

    ui_clear

    if ! network_authorize_prompt; then
        ui_echo "${YELLOW}Scan aborted by user.${NC}"
        log_to_file "Scan aborted by user."
        sleep 1
        return 1
    fi

    ui_echo "${GREEN}Authorization confirmed. Starting scan...${NC}"
    log_to_file "Authorization confirmed. Starting scan..."
    sleep 1

    ui_clear
    ui_echo
    ui_echo "${CYAN}${BOLD}Network vulnerability scan...${NC}"
    log_to_file "▶ Network vulnerability scan..."
    ui_echo
    ui_echo

    if ! command -v nmap &>/dev/null; then
        ui_echo "${RED}[ERROR]${NC} nmap is not installed"
        log_to_file "[ERROR] nmap is not installed"
        return 1
    fi

    local target
    target="$(network_get_target)" || {
        ui_echo "${RED}[ERROR]${NC} Could not determine network target"
        log_to_file "[ERROR] Could not determine network target"
        return 1
    }

    if ! network_is_private_target "$target"; then
        ui_echo "${RED}ERROR: Non-private target blocked ($target)${NC}"
        log_to_file "ERROR: Non-private target blocked ($target)"
        return 1
    fi

    ui_echo "${GREEN}${BOLD}▶ Target:${NC} $target"
    log_to_file "▶ Target: $target"
    ui_echo "${DIM}$(network_profile_display)${NC}"
    log_to_file "Profile: $NETWORK_PROFILE (timing $NETWORK_TIMING)"

    # Decide scan targets
    local scan_targets=()
    if [[ -n "$NETWORK_LAST_HOSTS_FILE" && -f "$NETWORK_LAST_HOSTS_FILE" && -s "$NETWORK_LAST_HOSTS_FILE" ]]; then
        mapfile -t scan_targets < "$NETWORK_LAST_HOSTS_FILE"
        ui_echo "${GREEN}[OK]${NC} Using discovered hosts list (${#scan_targets[@]} hosts)"
        log_to_file "[OK] Using discovered hosts list: $NETWORK_LAST_HOSTS_FILE"
    else
        ui_echo "${YELLOW}[INFO]${NC} No host list found; discovering hosts now"
        log_to_file "[INFO] No host list found; performing discovery"

        # quick discovery inline
        mapfile -t scan_targets < <(
            nmap -sn -"${NETWORK_TIMING}" -oG - "$target" 2>/dev/null \
                | awk '/Up$/{print $2}' | sort -u
        )
    fi

    if (( ${#scan_targets[@]} == 0 )); then
        ui_echo "${YELLOW}[INFO]${NC} No active hosts found"
        log_to_file "[INFO] No active hosts found"
        return 0
    fi

    # Port scope
    local port_arg=""
    if [[ -n "$NETWORK_TOP_PORTS" ]]; then
        port_arg="--top-ports $NETWORK_TOP_PORTS"
    else
        port_arg="-p-"
    fi

    # Choose NSE script sets (defensive)
    local nse=""
    case "$NETWORK_VULN_SCRIPTS" in
        safe)      nse="--script safe" ;;
        vuln)      nse="--script vuln" ;;
        safe+vuln) nse="--script safe,vuln" ;;
        *)         nse="--script safe" ;;
    esac

    # If vulners exists, include it
    if nmap --script-help vulners 2>/dev/null | grep -qi "vulners"; then
        nse="$nse,vulners"
    fi

    local out_dir ts out_base
    out_dir="$BASE_DIR/reports/network"
    mkdir -p "$out_dir"
    ts="$(date +%Y%m%d_%H%M%S)"
    out_base="$out_dir/vuln_${ts}"

    ui_echo
    ui_echo "${GREEN}${BOLD}▶ Open ports & services:${NC} $port_arg"
    log_to_file "▶ Open ports & services: $port_arg"

    nmap -sS -sV --open -"${NETWORK_TIMING}" $port_arg \
        -oN "${out_base}_services.txt" \
        "${scan_targets[@]}"

    log_to_file "Saved services: ${out_base}_services.txt"

    ui_echo
    ui_echo "${YELLOW}${BOLD}▶ Vulnerability checks:${NC} ${nse#--script }"
    log_to_file "▶ Vulnerability checks: ${nse#--script }"

    # Run NSE vuln/safe scripts
    nmap -sS -sV -"${NETWORK_TIMING}" $port_arg \
        $nse \
        -oN "${out_base}_nse.txt" \
        "${scan_targets[@]}"

    log_to_file "Saved NSE results: ${out_base}_nse.txt"

    if [[ "$NETWORK_ENABLE_UDP" -eq 1 ]]; then
        ui_echo
        ui_echo "${YELLOW}${BOLD}▶ UDP vulnerability surface:${NC} (top ports 100)"
        log_to_file "▶ UDP vulnerability surface (top ports 100)"

        nmap -sU --open -"${NETWORK_TIMING}" --top-ports 100 \
            -oN "${out_base}_udp.txt" \
            "${scan_targets[@]}"

        log_to_file "Saved UDP results: ${out_base}_udp.txt"
    fi

    ui_echo
    ui_echo "${CYAN}${BOLD}Network vulnerability scan completed.${NC}"
    log_to_file "✔ Network vulnerability scan completed"

    return 0
}

