
#!/usr/bin/env bash

# ----------------
# Module metadata
# ----------------
network_vulnerability_NAME="Network vulnerability"
network_vulnerability_DESC="
The Network vulnerability module focuses on network exposure and
service discovery.

This includes:
  • Active network interfaces
  • Open ports and listening services
  • Basic service fingerprinting
  • Reachable hosts (where applicable)

Purpose:
To understand how the system is exposed to the network and identify
services that may require hardening or restriction.
"
network_vulnerability_SAFETY="Explicit user authorization required. Scans only private IP ranges (RFC1918)
"

# ----------------------
# network_vulnerability
# ----------------------
network_vulnerability() {

    if declare -F ui_clear >/dev/null; then
        ui_clear
    fi

    ui_echo "${RED}${BOLD}WARNING!${NC}"
    log_to_file "WARNING!"
    ui_echo "You are about to perform a network vulnerability scan."
    log_to_file "You are about to perform a network vulnerability scan"
    ui_echo "You must have authorization to scan this network."
    log_to_file "You must have authorization to scan this network"
    ui_echo

    ui_read -rp "Type YES to continue (10s timeout): " -t 10 CONFIRM
    if [[ "${CONFIRM^^}" != "YES" ]]; then
        ui_echo "${YELLOW}Scan aborted by user.${NC}"
        log_to_file "Scan aborted by user."
        sleep 1
        return 1
    fi

    ui_echo "${GREEN}Authorization confirmed. Starting scan...${NC}"
    log_to_file "Authorization confirmed. Starting scan..."
    sleep 1

    ui_clear
    ui_echo
    ui_echo "${CYAN}${BOLD} Network vulnerability scan...${NC}"
    log_to_file "▶ Network vulnerability scan..."
    ui_echo
    ui_echo

    # Identify interface + CIDR
    IFACE=$(ip route | awk '/default/ {print $5}' | head -n 1)
    IP_RANGE=$(ip -o -f inet addr show "$IFACE" | awk '{print $4}' | head -n 1)

    if [[ -z "$IFACE" || -z "$IP_RANGE" ]]; then
        ui_echo "${RED}ERROR: Could not determine interface or IP range${NC}"
        log_to_file "ERROR: Could not determine interface or IP range"
        return 1
    fi

    # Only private ranges (RFC1918)
    if [[ ! "$IP_RANGE" =~ ^(10\.|192\.168\.|172\.(1[6-9]|2[0-9]|3[0-1])) ]]; then
        ui_echo "${RED}ERROR: Public IP range detected ($IP_RANGE)${NC}"
        log_to_file "ERROR: Public IP range detected ($IP_RANGE)"
        return 1
    fi

    ui_echo "${GREEN}${BOLD}▶ Interface:${NC} $IFACE"
    log_to_file "▶ Interface: $IFACE"
    ui_echo "${GREEN}${BOLD}▶ Target network:${NC} $IP_RANGE"
    log_to_file "▶ Target network: $IP_RANGE"
    ui_echo

    # -------------------------
    # Host discovery (robust)
    # -------------------------
    ui_echo "${GREEN}${BOLD}▶ Discovering active hosts...${NC}"
    log_to_file "▶ Discovering active hosts..."

    HOSTS=$(
        nmap -sn -T3 "$IP_RANGE" \
        | awk '/Nmap scan report for/' \
        | grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' \
        | sort -u
    )

    HOST_COUNT=$(echo "$HOSTS" | sed '/^\s*$/d' | wc -l)
    ui_echo "${GREEN}${BOLD}▶ Hosts found:${NC} $HOST_COUNT"
    log_to_file "▶ Hosts found: $HOST_COUNT"

    if [[ "$HOST_COUNT" -eq 0 ]]; then
        ui_echo "${RED}No active hosts found${NC}"
        log_to_file "No active hosts found"
        return 1
    fi

    # -------------------------
    # Per-host scanning
    # -------------------------
    for HOST in $HOSTS; do
        ui_echo
        ui_echo "${BLUE}${BOLD}▶ Analyzing host: $HOST${NC}"
        log_to_file "▶ Analyzing host: $HOST"

        # 1) Inventory scan: open ports + versions (fast-ish)
        ui_echo "${GREEN}• Open ports & service fingerprinting${NC}"
        log_to_file "Open ports & service fingerprinting"

        TMP_GNMAP="/tmp/limeseeker_${HOST}_ports.gnmap"
        TMP_NMAP="/tmp/limeseeker_${HOST}_ports.nmap"

        # Use -Pn to avoid ICMP/ARP edge cases once host is known
        # Add --version-light for faster version checks (can change to --version-all if you want deeper)
        nmap -Pn -sS -sV --version-light --open -T3 "$HOST" -oG "$TMP_GNMAP" -oN "$TMP_NMAP"

        # Show summary to terminal + log
        if [[ -f "$TMP_NMAP" ]]; then
            sed -n '1,120p' "$TMP_NMAP"
        fi

        # Extract open TCP ports
        OPEN_PORTS=$(awk -F'Ports: ' '/Ports: /{print $2}' "$TMP_GNMAP" 2>/dev/null \
            | tr ',' '\n' \
            | awk -F'/' '$2=="open"{print $1}' \
            | paste -sd, -)

        if [[ -z "$OPEN_PORTS" ]]; then
            ui_echo "${YELLOW}[INFO]${NC} No open ports detected on $HOST"
            log_to_file "[INFO] No open ports detected on $HOST"
            rm -f "$TMP_GNMAP" "$TMP_NMAP"
            continue
        fi

        ui_echo "${GREEN}${BOLD}▶ Open ports:${NC} $OPEN_PORTS"
        log_to_file "▶ Open ports: $OPEN_PORTS"
        ui_echo

        # 2) Targeted NSE scripts based on detected services/ports
        ui_echo "${YELLOW}• Targeted vulnerability & misconfiguration checks${NC}"
        log_to_file "Targeted vulnerability & misconfiguration checks"

        SCRIPTS=()

        # TLS/SSL likely services
        if echo "$OPEN_PORTS" | grep -Eq '(^|,)(443|8443|993|995|465|587|636|990|3389)(,|$)'; then
            SCRIPTS+=(ssl-cert ssl-enum-ciphers)
        fi

        # HTTP/HTTPS checks (headers/title) – useful “real-world” signal
        if echo "$OPEN_PORTS" | grep -Eq '(^|,)(80|443|8080|8000|8443)(,|$)'; then
            SCRIPTS+=(http-title http-headers http-security-headers)
        fi

        # SSH config posture
        if echo "$OPEN_PORTS" | grep -Eq '(^|,)(22)(,|$)'; then
            SCRIPTS+=(ssh2-enum-algos ssh-hostkey)
        fi

        # SMB posture (Windows/Samba)
        if echo "$OPEN_PORTS" | grep -Eq '(^|,)(445|139)(,|$)'; then
            SCRIPTS+=(smb2-security-mode smb2-time smb-security-mode)
        fi

        # DNS checks (lightweight)
        if echo "$OPEN_PORTS" | grep -Eq '(^|,)(53)(,|$)'; then
            SCRIPTS+=(dns-recursion dns-service-discovery)
        fi

        # “CVE hinting” – optional, only if installed and you want it
        # NOTE: vulners needs nmap-vulners script installed. If you have it, this gives CVE candidates.
        if nmap --script-help vulners >/dev/null 2>&1; then
            SCRIPTS+=(vulners)
        fi

        # If no scripts matched, at least run “default vuln category” lightly
        if [[ "${#SCRIPTS[@]}" -eq 0 ]]; then
            # 'vuln' category can be heavy; keep it conservative
            SCRIPTS+=(default)
        fi

        SCRIPT_LIST=$(IFS=,; echo "${SCRIPTS[*]}")

        ui_echo "${GREEN}${BOLD}▶ NSE scripts:${NC} $SCRIPT_LIST"
        log_to_file "▶ NSE scripts: $SCRIPT_LIST"

        # Run targeted scripts only on open ports (faster + cleaner)
        nmap -Pn -sV -p "$OPEN_PORTS" --script "$SCRIPT_LIST" -T3 "$HOST"

        rm -f "$TMP_GNMAP" "$TMP_NMAP"
    done

    return 0
}
